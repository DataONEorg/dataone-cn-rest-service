#!/bin/bash

LONG_DATE=`date +%Y%m%d%H%M%S`

TOMCAT=tomcat6
TOMCAT_USER=tomcat6
TOMCAT_HOME=/var/lib/tomcat6
APACHE_CONF=/etc/apache2
MOD_JK_CONF=/etc/libapache2-mod-jk
SITES="cn cn-ssl"
SOURCE_DIR=/usr/share/dataone-cn-rest
SCRIPT_DIR=${SOURCE_DIR}/debian
###############################################################################
# Install metacat war file
###############################################################################

## Stop tomcat
echo "Stopping Tomcat"
/etc/init.d/${TOMCAT} stop

## backup the old war file
if [ -e ${TOMCAT_HOME}/webapps/cn.war ]
then
  echo "Backing up ${TOMCAT_HOME}/webapps/cn.war to ${TOMCAT_HOME}/webapps/cn.war.${LONG_DATE}"
  mv ${TOMCAT_HOME}/webapps/cn.war ${TOMCAT_HOME}/webapps/cn.war.${LONG_DATE}
fi  

## remove the cn application directory
if [ -d ${TOMCAT_HOME}/webapps/cn ]
then
  echo "Removing the old metacat application directories"
  rm -rf ${TOMCAT_HOME}/webapps/cn
fi 

## copy the new war file into the webapps directory
echo copying new cn.war file to ${TOMCAT_HOME}/webapps/cn.war
cp ${SOURCE_DIR}/cn.war ${TOMCAT_HOME}/webapps/cn.war
chown -R ${TOMCAT_USER}.${TOMCAT_USER} ${TOMCAT_HOME}/webapps/cn.war

## expand the war file
CURR_DIR=`pwd`

## make knb directory and extract cn.war into it.
echo "Making knb application directory: ${TOMCAT_HOME}/webapps/cn"
mkdir ${TOMCAT_HOME}/webapps/cn
cd ${TOMCAT_HOME}/webapps/cn

echo "extracting knb.war into ${TOMCAT_HOME}/webapps/cn"
jar -xvf ${TOMCAT_HOME}/webapps/cn.war > /dev/null
chown -R ${TOMCAT_USER}.${TOMCAT_USER} ${TOMCAT_HOME}/webapps/cn
echo cd to $CURR_DIR
cd $CURR_DIR


###############################################################################
# Configure Tomcat
###############################################################################

# Configure the context file
cp ${SCRIPT_DIR}/cn.xml ${TOMCAT_HOME}/conf/Catalina/localhost/
chown -R ${TOMCAT_USER}.${TOMCAT_USER} ${TOMCAT_HOME}/conf/Catalina/localhost/cn.xml
# Add permissions needed by cn
cp ${SCRIPT_DIR}/51cn.policy ${TOMCAT_HOME}/conf/policy.d/
chown -R ${TOMCAT_USER}.${TOMCAT_USER} ${TOMCAT_HOME}/conf/policy.d/51cn.policy
###############################################################################
# Configure Apache
###############################################################################

## Stop apache
echo "Stopping Apache"
/etc/init.d/apache2 stop

## copy in site configuration files
for SITE in ${SITES}
do
    if [ -e ${APACHE_CONF}/sites-available/${SITE} ]
    then 
      SITE_DIFF=`diff ${SCRIPT_DIR}/${SITE} ${APACHE_CONF}/sites-available/${SITE}`
      if [ "${SITE_DIFF}" != "" ]
      then
        echo "Backing up ${APACHE_CONF}/sites-available/${SITE} to ${APACHE_CONF}/sites-available/${SITE}.${LONG_DATE}"
        mv ${APACHE_CONF}/sites-available/${SITE} ${APACHE_CONF}/sites-available/${SITE}.${LONG_DATE}
      fi
    fi
    echo "Copying ${SITE} site file to ${APACHE_CONF}/sites-available/"
    cp ${SCRIPT_DIR}/${SITE} ${APACHE_CONF}/sites-available/

    ## enable ${SITE} site
    echo "Enabling ${SITE} site"
    a2dissite ${SITE}
    a2ensite ${SITE}
done

# Turn on the ssl module
echo "Refreshing Mod SSL"
a2dismod ssl
a2enmod ssl


###############################################################################
# Start Apache and Tomcat
###############################################################################

## Start Apache
/etc/init.d/apache2 start


## Start Tomcat
echo "starting Tomcat server"


/etc/init.d/${TOMCAT} start


